# 进货收货管理系统 - 使用说明

## 系统升级完成

您的进货管理系统已升级为 **类似销售管理的付款和收货模式**！

## 新增功能

### 1️⃣ **付款状态字段**
- 取代原来的单一"状态"字段
- 显示：✅ 已付款 / ❌ 未付款
- 类似销售管理的"已收款"字段

### 2️⃣ **收货状态字段**
- 显示三种状态：
  - **未收货** - 所有品项都未收货
  - **部分收货** - 部分品项已收货
  - **已收货** - 全部品项已收货

### 3️⃣ **按品项收货功能**
- ✅ 点击每个品项的"收货"按钮
- ✅ 输入收货数量（支持部分收货）
- ✅ 自动增加库存
- ✅ 自动生成收货单（R0001, R0002...）
- ✅ 显示已收货/总数量（如：5/10）

## 数据库变更

### 新增表
1. **purchase_receivings** - 进货收货记录表
2. **purchase_receiving_items** - 进货收货明细表

### 新增字段
**purchases 表：**
- `is_paid` - 是否已付款
- `receiving_status` - 收货状态（none/partial/completed）

**purchase_items 表：**
- `received_quantity` - 已收货数量
- `is_received` - 是否已全部收货

## 使用流程

### 场景 1：完整进货流程
```
1. 创建进货单
   - 选择廠商
   - 添加商品
   - 勾選"已付款"（如果已付款）

2. 进货单创建成功后
   - 付款状态：显示"已付款"或"未付款"
   - 收货状态：显示"未收货"

3. 商品到货时
   - 展开进货单明细
   - 点击每个品项的"收货"按钮
   - 输入收货数量
   - 库存自动增加

4. 全部收货完成
   - 收货状态自动变为"已收货"
   - 所有品项显示绿色的"10/10"
```

### 场景 2：分批收货
```
1. 第一批到货（5 件）
   - 点击"收货"按钮
   - 输入：5
   - 显示：5/10（黄色）
   - 收货状态：部分收货

2. 第二批到货（5 件）
   - 再次点击"收货"按钮
   - 输入：5
   - 显示：10/10（绿色）
   - 收货状态：已收货
```

## API 端点

### 按品项收货
```
POST /api/purchase-items/:id/receive
Body: { quantity: 10 }
```

响应：
```json
{
  "ok": true,
  "message": "收货成功！收货单号：R0001",
  "data": { ... }
}
```

## 数据库触发器

### 自动增加库存
收货时自动执行：
1. 增加 `products.stock`
2. 记录 `inventory_logs`
3. 更新 `purchase_items.received_quantity`
4. 更新 `purchase_items.is_received`
5. 更新 `purchases.receiving_status`

## 页面显示

### 进货列表
| 进货单号 | 廠商 | 日期 | 商品数 | 总数量 | 付款 | 收货 | 操作 |
|---------|------|------|--------|--------|------|------|------|
| P0001 | 供应商A | 2026-01-12 | 3 | 50 | ✅已付款 | ⚠️部分收货 | 删除 |

### 进货明细
| 品号 | 商品名称 | 进货数量 | 已收货 | 成本 | 小计 | 操作 |
|------|----------|----------|--------|------|------|------|
| A001 | 商品A | 10 | <span style="color:green">10/10</span> | $100 | $1,000 | 删除 |
| A002 | 商品B | 20 | <span style="color:orange">5/20</span> | $50 | $1,000 | 收货 \| 删除 |

## 现有数据迁移

执行 SQL 脚本后：
- ✅ 所有已确认的进货单自动标记为"已付款"和"已收货"
- ✅ 所有已确认的进货明细自动标记为"已收货"（received_quantity = quantity）

## 执行步骤

### 步骤 1：执行数据库迁移
在 Supabase SQL Editor 中执行：
```bash
database/migrations/006_add_purchase_receiving.sql
```

### 步骤 2：重启开发服务器
```bash
npm run dev
```

### 步骤 3：测试功能
1. 访问 `/purchases` 页面
2. 创建一笔新的进货单
3. 展开进货明细
4. 点击"收货"按钮
5. 输入收货数量
6. 检查库存是否增加

## 注意事项

1. **已收货的品项**不显示"收货"按钮
2. **收货数量**不能超过剩余数量
3. **同一天**对同一进货单的多次收货会使用同一个收货单号
4. **库存增加**由数据库触发器自动处理
5. **删除进货明细**时，如果已收货需要手动回补库存（TODO：后续优化）

## 预期结果

- ✅ 进货列表显示付款和收货状态
- ✅ 可以按品项进行收货
- ✅ 支持分批收货
- ✅ 自动生成收货单
- ✅ 库存自动增加
- ✅ 收货状态自动更新

---

🎉 恭喜！进货管理系统升级完成！
